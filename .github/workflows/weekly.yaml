name: "[schedule] weekly"
# badFileName.js @Monday
# mostTranscludedPages.js @Tuesday
# badDisplayTitle.js @Tuesday
# shortPages.js @Wednesday
# tentativeTitle.js @Wednesday
# checkLeaderActivities.js @Thursday
# fileRevisionDelete.js @Thursday
# needImprove.js @Friday
# needImproveWelcome.js @Friday
# addCategoryRedirect.js @Saturday
# brokenFileLinks.js @Sunday

on:
  schedule:
    - cron: "55 21 * * 0" # Monday 05:55 CST
    - cron: "55 21 * * 1" # Tuesday 05:55 CST
    - cron: "55 21 * * 2" # Wednesday 05:55 CST
    - cron: "55 21 * * 3" # Thursday 05:55 CST
    - cron: "55 21 * * 4" # Friday 05:55 CST
    - cron: "55 21 * * 5" # Saturday 05:55 CST
    - cron: "55 21 * * 6" # Sunday 05:55 CST
  workflow_dispatch:
    inputs:
      task:
        type: choice
        required: true
        default: "none"
        options:
          - "none"
          - "bad-file-name"
          - "most-transcluded-pages"
          - "bad-display-title"
          - "short-pages"
          - "tentative-title"
          - "check-leader-activities"
          - "file-revision-deletion"
          - "need-improve"
          - "need-improve-welcome"
          - "add-category-redirect"
          - "broken-file-links"
      group:
        type: choice
        required: true
        default: "none"
        options:
          - "none"
          - "need-improve"
          - "all"

env:
  MOEGIRL_API_USER_AGENT: ${{ secrets.MOEGIRL_API_USER_AGENT }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  bad-file-name:
    if: |
      github.event.schedule == '55 21 * * 0' || 
      github.event.inputs.task == 'bad-file-name' ||
      github.event.inputs.group == 'all'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set Node Version
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Run Script
        env:
          ZH_IBOT: ${{ secrets.ZH_IBOT }}
          CM_IBOT: ${{ secrets.CM_IBOT }}
        run: node src/badFileName.js

  most-transcluded-pages:
    if: |
      github.event.schedule == '55 21 * * 1' || 
      github.event.inputs.task == 'most-transcluded-pages' ||
      github.event.inputs.group == 'all'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set Node Version
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Run Script
        env:
          ZH_IBOT: ${{ secrets.ZH_IBOT }}
        run: node src/mostTranscludedPages.js

  bad-display-title:
    if: |
      github.event.schedule == '55 21 * * 1' || 
      github.event.inputs.task == 'bad-display-title' ||
      github.event.inputs.group == 'all'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set Node Version
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Run Script
        env:
          ZH_IBOT: ${{ secrets.ZH_IBOT }}
        run: node src/badDisplayTitle.js

  short-pages:
    if: |
      github.event.schedule == '55 21 * * 2' || 
      github.event.inputs.task == 'short-pages' ||
      github.event.inputs.group == 'all'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set Node Version
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Run Script
        env:
          ZH_IBOT: ${{ secrets.ZH_IBOT }}
        run: node src/shortPages.js

  tentative-title:
    if: |
      github.event.schedule == '55 21 * * 2' || 
      github.event.inputs.task == 'tentative-title' ||
      github.event.inputs.group == 'all'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set Node Version
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Run Script
        env:
          ZH_IBOT: ${{ secrets.ZH_IBOT }}
        run: node src/tentativeTitle.js

  check-leader-activities:
    if: |
      github.event.schedule == '55 21 * * 3' || 
      github.event.inputs.task == 'check-leader-activities' ||
      github.event.inputs.group == 'all'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set Node Version
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Run Script
        env:
          ZH_IBOT: ${{ secrets.ZH_IBOT }}
          CM_IBOT: ${{ secrets.CM_IBOT }}
        run: node src/checkLeaderActivities.js

  file-revision-deletion:
    if: |
      github.event.schedule == '55 21 * * 3' || 
      github.event.inputs.task == 'file-revision-deletion' ||
      github.event.inputs.group == 'all'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set Node Version
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Run Script
        env:
          CM_ABOT: ${{ secrets.CM_ABOT }}
        run: node src/fileRevisionDelete.js

  need-improve:
    if: |
      github.event.schedule == '55 21 * * 4' || 
      github.event.inputs.task == 'need-improve' ||
      github.event.inputs.group == 'need-improve' ||
      github.event.inputs.group == 'all'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set Node Version
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Run Script
        env:
          ZH_IBOT: ${{ secrets.ZH_IBOT }}
        run: node src/needImprove.js

  need-improve-welcome:
    if: |
      github.event.schedule == '55 21 * * 4' || 
      github.event.inputs.task == 'need-improve-welcome' ||
      github.event.inputs.group == 'need-improve' ||
      github.event.inputs.group == 'all'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set Node Version
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Run Script
        env:
          ZH_IBOT: ${{ secrets.ZH_IBOT }}
        run: node src/needImproveWelcome.js

  add-category-redirect:
    if: |
      github.event.schedule == '55 21 * * 5' || 
      github.event.inputs.task == 'add-category-redirect' ||
      github.event.inputs.group == 'all'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set Node Version
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Run Script
        env:
          ZH_BOT: ${{ secrets.ZH_BOT }}
          CM_BOT: ${{ secrets.CM_BOT }}
        run: node src/addCategoryRedirect.js

  broken-file-links:
    if: |
      github.event.schedule == '55 21 * * 6' || 
      github.event.inputs.task == 'broken-file-links' ||
      github.event.inputs.group == 'all'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set Node Version
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Run Script
        env:
          ZH_IBOT: ${{ secrets.ZH_IBOT }}
          CM_IBOT: ${{ secrets.CM_IBOT }}
        run: node src/brokenFileLinks.js
